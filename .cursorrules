# RÃ¨gles de dÃ©veloppement EcoPanier pour l'IA

## ğŸ“‹ Contexte du projet

**EcoPanier** est une plateforme anti-gaspillage alimentaire avec volet solidaritÃ© sociale (paniers suspendus).
Elle connecte commerÃ§ants, clients, bÃ©nÃ©ficiaires et collecteurs pour sauver des invendus tout en aidant les personnes en prÃ©caritÃ©.

### Mission principale
- RÃ©duire le gaspillage alimentaire en sauvant les invendus
- Promouvoir la solidaritÃ© via les paniers suspendus
- Soutenir les commerces locaux engagÃ©s
- Faciliter la logistique solidaire avec les collecteurs

### Utilisateurs (6 rÃ´les)
1. **Client** : AchÃ¨te des lots Ã  prix rÃ©duits, offre des paniers suspendus
2. **CommerÃ§ant** : CrÃ©e des lots d'invendus, gÃ¨re une station de retrait, utilise l'IA pour analyser les images
3. **BÃ©nÃ©ficiaire** : AccÃ¨de aux lots gratuits et paniers suspendus (max 2/jour)
4. **Association** : Enregistre et gÃ¨re les bÃ©nÃ©ficiaires partenaires, statistiques avancÃ©es, export de donnÃ©es
5. **Collecteur** : Effectue les livraisons solidaires contre rÃ©munÃ©ration
6. **Admin** : GÃ¨re la plateforme, les utilisateurs et les paramÃ¨tres

---

## ğŸ› ï¸ Stack technique

### Frontend
- **React 18.3.1** avec **TypeScript 5.5.3** (OBLIGATOIRE, jamais `any`)
- **Vite 5.4.2** comme build tool
- **React Router DOM 7.9.4** pour le routing
- **Tailwind CSS 3.4.1** pour le styling (JAMAIS de styles inline)
- **Zustand 5.0.8** pour l'Ã©tat global
- **Lucide React** pour les icÃ´nes
- **Recharts 3.2.1** pour les graphiques
- **date-fns 4.1.0** pour les dates

### Backend
- **Supabase 2.57.4** (BaaS)
  - PostgreSQL pour la base de donnÃ©es
  - Supabase Auth pour l'authentification
  - Row Level Security (RLS) sur tables sensibles
  - Storage pour les images (futur)
  - Realtime pour notifications (futur)

### QR Code & IA
- **qrcode.react** et **@yudiel/react-qr-scanner** pour les QR codes
- **@google/generative-ai** (Gemini 2.0 Flash) pour l'analyse d'images de lots

---

## ğŸ“ Structure du projet

```
src/
â”œâ”€â”€ components/              # Composants organisÃ©s par domaine mÃ©tier
â”‚   â”œâ”€â”€ admin/              # Dashboard admin, analytics, logs, settings
â”‚   â”œâ”€â”€ auth/               # Authentification
â”‚   â”œâ”€â”€ beneficiary/        # Interface bÃ©nÃ©ficiaire
â”‚   â”œâ”€â”€ collector/          # Interface collecteur
â”‚   â”œâ”€â”€ customer/           # Interface client
â”‚   â”œâ”€â”€ merchant/           # Interface commerÃ§ant
â”‚   â”œâ”€â”€ landing/            # Page d'accueil publique
â”‚   â”œâ”€â”€ pages/              # Pages gÃ©nÃ©riques
â”‚   â”œâ”€â”€ pickup/             # Station de retrait
â”‚   â””â”€â”€ shared/             # Composants rÃ©utilisables
â”œâ”€â”€ contexts/               # React Context (SettingsContext)
â”œâ”€â”€ hooks/                  # Hooks personnalisÃ©s
â”œâ”€â”€ lib/                    # Configuration (supabase.ts, types DB)
â”œâ”€â”€ stores/                 # Zustand stores (authStore)
â”œâ”€â”€ utils/                  # Fonctions utilitaires
â”œâ”€â”€ App.tsx                 # Routing principal
â””â”€â”€ main.tsx                # Point d'entrÃ©e
```

**RÃ¨gle architecture** : Utiliser une architecture feature-based. Chaque domaine mÃ©tier a ses propres composants isolÃ©s.

---

## ğŸ¯ Conventions de code STRICTES

### 1. TypeScript (OBLIGATOIRE)

```typescript
// âœ… TOUJOURS faire Ã§a
interface UserProfile {
  id: string;
  fullName: string;
  role: 'customer' | 'merchant' | 'beneficiary' | 'association' | 'collector' | 'admin';
}

function fetchProfile(userId: string): Promise<UserProfile> {
  // Implementation typÃ©e
}

// âŒ JAMAIS faire Ã§a
function fetchProfile(userId: any) {
  // Pas de types = INTERDIT
}
```

**RÃ¨gle** : Jamais d'`any` sauf cas exceptionnel justifiÃ©. TOUJOURS typer les fonctions, props, variables.

### 2. Nommage

| Ã‰lÃ©ment | Convention | Exemple |
|---------|-----------|---------|
| **Composants** | PascalCase | `UserProfile.tsx`, `LotCard.tsx` |
| **Fichiers composants** | PascalCase | `CustomerDashboard.tsx` |
| **Hooks** | camelCase + `use` | `useAuthStore.ts`, `useLotFilters.ts` |
| **Fonctions** | camelCase | `fetchUserData()`, `calculatePrice()` |
| **Variables** | camelCase | `const userData = ...` |
| **Constantes** | UPPER_SNAKE_CASE | `const MAX_RETRY = 3`, `const PIN_LENGTH = 6` |
| **Types/Interfaces** | PascalCase | `interface UserProfile {}` |
| **Fichiers utils** | camelCase | `helpers.ts`, `validationHelpers.ts` |

### 3. Structure d'un composant React

```typescript
// ORDRE OBLIGATOIRE :

// 1. Imports externes
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';

// 2. Imports internes (stores, contexts, components)
import { useAuthStore } from '@/stores/authStore';
import { Button } from '@/components/shared/Button';

// 3. Imports types
import type { User } from '@/lib/database.types';

// 4. DÃ©finition des types/interfaces
interface MyComponentProps {
  user: User;
  onAction?: () => void;
}

// 5. Composant
export function MyComponent({ user, onAction }: MyComponentProps) {
  // A. Ã‰tat local
  const [loading, setLoading] = useState(false);
  
  // B. Hooks (stores, contexts, router)
  const { profile } = useAuthStore();
  const navigate = useNavigate();
  
  // C. Effets
  useEffect(() => {
    // Side effects
  }, [user]);
  
  // D. Handlers
  const handleClick = async () => {
    setLoading(true);
    // Logic
    setLoading(false);
  };
  
  // E. Early returns (conditions de sortie)
  if (!user) return null;
  if (loading) return <LoadingSpinner />;
  
  // F. Render principal
  return (
    <div className="card">
      {/* JSX */}
    </div>
  );
}
```

### 4. Gestion d'erreurs Supabase (PATTERN OBLIGATOIRE)

```typescript
// âœ… TOUJOURS faire Ã§a
try {
  const { data, error } = await supabase
    .from('lots')
    .select();
  
  if (error) throw error;
  
  return data;
} catch (error) {
  console.error('Description de l\'erreur:', error);
  // Message utilisateur-friendly
  throw new Error('Impossible de charger les lots. VÃ©rifiez votre connexion.');
}

// âŒ JAMAIS ignorer les erreurs
const { data } = await supabase.from('lots').select(); // OÃ¹ est error?
```

### 5. Classes Tailwind (ORDRE OBLIGATOIRE)

**Ordre** : Layout â†’ Spacing â†’ Sizing â†’ Colors â†’ Typography â†’ Effects

```tsx
// âœ… BON - Classes organisÃ©es logiquement
<div className="flex items-center justify-between gap-4 p-6 w-full bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow">

// âŒ MAUVAIS - Classes dÃ©sordonnÃ©es
<div className="shadow-md bg-white w-full gap-4 rounded-lg hover:shadow-lg p-6 flex items-center">
```

**Classes personnalisÃ©es disponibles** (Ã  utiliser) :
- `.card` : Carte standard
- `.btn-primary` : Bouton principal
- `.btn-secondary` : Bouton secondaire
- `.section-gradient` : DÃ©gradÃ© de section
- `.hover-lift` : Effet de levÃ©e au hover
- `.animate-fade-in-up` : Animation d'entrÃ©e

---

## ğŸ—„ï¸ Base de donnÃ©es & Supabase

### Tables principales

1. **profiles** : Profils utilisateurs (Ã©tend auth.users)
   - `role`: customer | merchant | beneficiary | collector | admin
   - `beneficiary_id`: Format YYYY-BEN-XXXXX pour bÃ©nÃ©ficiaires

2. **lots** : Lots d'invendus crÃ©Ã©s par commerÃ§ants
   - `status`: available | reserved | sold_out | expired
   - `quantity_total`, `quantity_reserved`, `quantity_sold`

3. **reservations** : RÃ©servations avec code PIN Ã  6 chiffres
   - `pickup_pin`: Code pour retrait
   - `status`: pending | confirmed | completed | cancelled

4. **suspended_baskets** : Paniers suspendus (solidaritÃ©)
   - `donor_id`, `merchant_id`, `claimed_by`
   - `status`: available | reserved | claimed | expired

5. **missions** : Missions pour collecteurs
   - `collector_id`, `merchant_id`
   - `status`: available | accepted | in_progress | completed | cancelled

### RequÃªtes Supabase avec relations (JOIN)

```typescript
// âœ… BON - Single query avec relations
const { data } = await supabase
  .from('lots')
  .select(`
    *,
    merchant:profiles!merchant_id(full_name, business_name, phone)
  `)
  .eq('status', 'available');

// âŒ MAUVAIS - Multiple queries
const lots = await supabase.from('lots').select();
for (const lot of lots) {
  const merchant = await supabase.from('profiles').select().eq('id', lot.merchant_id);
}
```

### Filtres Supabase

```typescript
.eq('column', value)           // Ã‰galitÃ©
.neq('column', value)          // DiffÃ©rent
.gt('column', value)           // Plus grand
.gte('column', value)          // Plus grand ou Ã©gal
.lt('column', value)           // Plus petit
.ilike('column', '%search%')   // LIKE insensible Ã  la casse
.in('column', [val1, val2])    // IN
.is('column', null)            // IS NULL
.order('column', { ascending: false })
.limit(10)
.range(0, 9)                   // Pagination
```

---

## ğŸ¯ Patterns spÃ©cifiques EcoPanier

### 1. Authentification

```typescript
// Store global authStore (Zustand)
const { user, profile, signIn, signOut } = useAuthStore();

// Protection de route
if (!user) return <Navigate to="/login" />;

// Protection par rÃ´le
if (profile?.role !== 'admin') return <AccessDenied />;
```

### 2. QR Code & Retrait

**GÃ©nÃ©ration** :
```typescript
import { QRCodeSVG } from 'qrcode.react';

const qrData = JSON.stringify({
  reservationId: reservation.id,
  pin: reservation.pickup_pin,
  userId: user.id,
  lotId: reservation.lot_id,
  timestamp: new Date().toISOString()
});

<QRCodeSVG value={qrData} size={200} />
```

**Scan et validation** :
```typescript
// 1. Scanner le QR
const { reservationId, pin } = JSON.parse(qrCodeData);

// 2. RÃ©cupÃ©rer la rÃ©servation
const { data: reservation } = await supabase
  .from('reservations')
  .select('*, lot:lots(*)')
  .eq('id', reservationId)
  .single();

// 3. Valider le PIN
if (inputPin !== reservation.pickup_pin) {
  throw new Error('Code PIN incorrect');
}

// 4. Marquer comme complÃ©tÃ©
await supabase
  .from('reservations')
  .update({
    status: 'completed',
    completed_at: new Date().toISOString()
  })
  .eq('id', reservationId);
```

### 3. Calcul d'impact (FORMULES STANDARDS)

```typescript
// Formules Ã  utiliser
const mealsSaved = quantity;
const co2Saved = quantity * 0.9; // 0.9 kg COâ‚‚ par repas (source: ADEME)
const moneySaved = originalPrice - discountedPrice;
```

### 4. Analyse IA avec Gemini (Nouveau)

```typescript
// Service Gemini pour analyse d'images
import { analyzeImageWithGemini } from '@/utils/geminiService';

// Analyser une image de produit alimentaire
const result = await analyzeImageWithGemini(imageFile);

// RÃ©sultat contient: title, description, category, prices, quantity, etc.
if (result.success) {
  // PrÃ©-remplir le formulaire avec les donnÃ©es extraites
  setFormData(result.data);
}
```

---

## ğŸš« Anti-patterns Ã  Ã‰VITER ABSOLUMENT

### âŒ Ã€ NE JAMAIS FAIRE

1. **Utiliser `any` sans raison**
```typescript
function process(data: any) { } // INTERDIT
```

2. **Ignorer les erreurs Supabase**
```typescript
const { data } = await supabase.from('lots').select(); // INTERDIT
```

3. **Mutations directes d'Ã©tat**
```typescript
state.value = newValue; // INTERDIT - utiliser setState
```

4. **Composants trop gros** (> 300 lignes)
â†’ Diviser en sous-composants

5. **Logique mÃ©tier dans les composants**
â†’ Extraire dans `utils/` ou `hooks/`

6. **Styles inline**
```tsx
<div style={{ color: 'red' }}> // INTERDIT - utiliser Tailwind
```

7. **Commits non descriptifs**
```bash
git commit -m "fix" // INTERDIT
git commit -m "update stuff" // INTERDIT
```

---

## âœ… Bonnes pratiques OBLIGATOIRES

### 1. Typer tout avec TypeScript

```typescript
// âœ… Utiliser les types Supabase gÃ©nÃ©rÃ©s
import type { Database } from '@/lib/database.types';
type Profile = Database['public']['Tables']['profiles']['Row'];
```

### 2. GÃ©rer toutes les erreurs explicitement

```typescript
try {
  await doSomething();
} catch (error) {
  console.error('Context de l\'erreur:', error);
  // Message utilisateur-friendly
  throw new Error('Message clair pour l\'utilisateur');
}
```

### 3. Extraire les constantes

```typescript
// âœ… BON
const MAX_RESERVATIONS_PER_DAY = 2;
const PIN_LENGTH = 6;
const CO2_PER_MEAL = 0.9;

// âŒ MAUVAIS - Nombres magiques
if (count > 2) { ... }
```

### 4. Utiliser les hooks personnalisÃ©s pour logique rÃ©utilisable

```typescript
// hooks/useLotFilters.ts
export function useLotFilters() {
  // Logic rÃ©utilisable
  return { filteredLots, setFilter };
}
```

### 5. Loading states et optimistic UI

```typescript
const [loading, setLoading] = useState(false);

const handleAction = async () => {
  setLoading(true);
  try {
    await doAction();
  } finally {
    setLoading(false);
  }
};
```

### 6. Composants rÃ©utilisables dans shared/

```typescript
// shared/Button.tsx
export function Button({ children, variant = 'primary', ...props }) {
  const className = variant === 'primary' ? 'btn-primary' : 'btn-secondary';
  return <button className={className} {...props}>{children}</button>;
}
```

---

## ğŸ” SÃ©curitÃ©

### RÃ¨gles importantes

1. **Jamais de secrets dans le frontend** â†’ Variables d'env uniquement
2. **Valider cÃ´tÃ© serveur** (RLS policies Supabase)
3. **VÃ©rifier les rÃ´les** avant affichage de donnÃ©es sensibles
4. **Sanitiser les entrÃ©es** (Supabase le fait, mais attention aux XSS)
5. **HTTPS obligatoire** en production

### Row Level Security (RLS)

- **ActivÃ©** : `platform_settings`, `suspended_baskets`
- **DÃ©sactivÃ© (MVP)** : autres tables pour simplicitÃ©

**En production**, activer RLS partout avec policies strictes.

---

## ğŸ“± Responsive Design

### Breakpoints Tailwind

- `sm`: 640px
- `md`: 768px (tablette)
- `lg`: 1024px (desktop)
- `xl`: 1280px
- `2xl`: 1536px

### Pattern mobile-first

```tsx
<div className="
  flex flex-col          /* Mobile: colonne */
  md:flex-row           /* Tablette+: ligne */
  gap-4 md:gap-6        /* Espacement adaptatif */
">
```

---

## ğŸ“ Commentaires

### Quand commenter

âœ… **Commenter** :
- Logique complexe non Ã©vidente
- Workarounds temporaires (+ TODO)
- Calculs avec formules (ex: COâ‚‚)
- Fonctions publiques (JSDoc)

âŒ **Ne PAS commenter** :
- Code Ã©vident
- RÃ©pÃ©ter ce que le code dit dÃ©jÃ 

```typescript
// âœ… BON
/**
 * Calcule l'impact environnemental d'un repas sauvÃ©
 * Formule : 0.9 kg COâ‚‚ par repas (source: ADEME 2024)
 */
function calculateCO2Impact(meals: number): number {
  return meals * 0.9;
}

// âŒ MAUVAIS
// Cette fonction additionne deux nombres
function add(a: number, b: number) {
  return a + b; // Retourne la somme
}
```

---

## ğŸ”„ Workflow Git

### Commits conventionnels (OBLIGATOIRE)

```bash
feat(lots): add search filter by category
fix(auth): correct PIN validation logic
docs(readme): update installation steps
refactor(components): simplify UserCard
style(lots): improve card spacing
test(reservations): add PIN validation tests
chore(deps): update Supabase to 2.57.4
```

**Format** : `<type>(<scope>): <description>`

**Types** :
- `feat`: Nouvelle fonctionnalitÃ©
- `fix`: Correction de bug
- `docs`: Documentation
- `refactor`: Refactoring
- `style`: Formatage/UI
- `test`: Tests
- `chore`: Maintenance

---

## ğŸ’¡ TÃ¢ches courantes

### Ajouter une nouvelle fonctionnalitÃ©

1. **CrÃ©er une branche** : `feature/nom-fonctionnalite`
2. **Placer le code** dans le bon dossier domain (`admin/`, `customer/`, etc.)
3. **Typer tout** avec TypeScript
4. **GÃ©rer les erreurs** explicitement
5. **Tester manuellement** en dev
6. **Commit** avec message conventionnel
7. **Ouvrir une PR** vers `develop`

### Ajouter un endpoint Supabase

```typescript
// 1. DÃ©finir le type (si nouveau)
type NewData = Database['public']['Tables']['new_table']['Row'];

// 2. CrÃ©er la fonction
async function fetchNewData(id: string): Promise<NewData> {
  const { data, error } = await supabase
    .from('new_table')
    .select('*')
    .eq('id', id)
    .single();
  
  if (error) throw error;
  return data;
}

// 3. GÃ©rer les erreurs dans le composant
try {
  const data = await fetchNewData(id);
  setData(data);
} catch (error) {
  console.error('Erreur:', error);
  setError('Message utilisateur-friendly');
}
```

### Ajouter une table DB

1. **CrÃ©er une migration** dans `supabase/migrations/`
2. **Nommer** : `YYYYMMDD_description.sql`
3. **DÃ©finir la table** avec contraintes et indexes
4. **Mettre Ã  jour** `database.types.ts` (gÃ©nÃ©rer via Supabase CLI)
5. **Documenter** dans `DB_SCHEMA.md`

---

## ğŸ¨ Design System

### Couleurs Tailwind personnalisÃ©es

```typescript
colors: {
  primary: { 50-950 },    // Bleu (brand)
  secondary: { 50-950 },  // Violet
  accent: { 50-950 },     // Rouge
  success: { 50-950 },    // Vert
  warning: { 50-950 },    // Orange
  neutral: { 50-950 },    // Gris
}
```

### Animations personnalisÃ©es

```css
animate-fade-in
animate-fade-in-up
animate-slide-in-right
animate-float
animate-pulse-soft
animate-shimmer
```

---

## ğŸ” DÃ©pendances Ã  privilÃ©gier

- **State management** : Zustand (lÃ©ger et simple)
- **Forms** : React Hook Form (futur)
- **Dates** : date-fns (pas moment.js)
- **Icons** : Lucide React (cohÃ©rent avec le design)
- **Charts** : Recharts (simple et performant)
- **Notifications** : Toast custom (Ã©viter bibliothÃ¨ques lourdes)

---

## ğŸš¨ Choses Ã  Ã©viter

- âŒ `console.log()` oubliÃ©s en production (utiliser `console.error` pour erreurs)
- âŒ BibliothÃ¨ques lourdes inutiles (vÃ©rifier bundle size)
- âŒ RequÃªtes Supabase dans des boucles (utiliser JOINs)
- âŒ Re-renders inutiles (utiliser `React.memo`, `useMemo`, `useCallback`)
- âŒ Hardcoded strings qui devraient Ãªtre des constantes
- âŒ Logique mÃ©tier dupliquÃ©e (factoriser dans utils/hooks)

---

## ğŸ“š Documentation obligatoire

### Quand documenter

1. **Nouvelle feature** : Ajouter exemple dans README si pertinent
2. **Nouveau hook/util** : JSDoc avec exemples
3. **Changement de DB** : Mettre Ã  jour DB_SCHEMA.md
4. **Nouveau pattern** : Ajouter dans .cursorrules
5. **Breaking change** : Documenter dans CHANGELOG

---

## ğŸ¯ Checklist avant commit

- [ ] Code compile sans erreur (`npm run build`)
- [ ] Linter passe (`npm run lint`)
- [ ] TypeCheck passe (`npm run typecheck`)
- [ ] Pas de `console.log` oubliÃ©s
- [ ] Pas de `any` TypeScript
- [ ] Gestion d'erreurs prÃ©sente
- [ ] Composants responsive testÃ©s
- [ ] Code commentÃ© si logique complexe
- [ ] Message de commit descriptif
- [ ] Variables d'environnement documentÃ©es si nouvelles

---

## ğŸ’¡ Philosophie du projet

**SimplicitÃ© > ComplexitÃ©** : PrivilÃ©gier les solutions simples et maintenables.

**Performance** : Optimiser mais sans sur-optimisation prÃ©maturÃ©e.

**AccessibilitÃ©** : Interface utilisable par tous (contraste, navigation clavier).

**Impact social** : Chaque ligne de code contribue Ã  rÃ©duire le gaspillage et aider les personnes dans le besoin.

---

**Version** : 1.0.0  
**DerniÃ¨re mise Ã  jour** : Janvier 2025  
**Pour plus de dÃ©tails** : Voir README.md, ARCHITECTURE.md, API_DOCS.md, DB_SCHEMA.md
